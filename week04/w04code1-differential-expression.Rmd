---
title: "Differential Expression - 2 groups"
author: "ks"
date: "`r Sys.Date()`"
output: html_document
---

# {.tabset}


## Prostate data

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
st <- Sys.time()
if (!require(genefilter)) BiocManager::install("genefilter")
library(genefilter)
library(limma)
library(ggplot2)
```

There was a total of 6 treatment groups, but I'm going to introduce 2-sample t-tests by focusing on just two treatment groups:    
siNS_0hr vs siNS_16hr    


Load the data (from JBC (2012)).
```{r ReadData}
jbcdir=c("../data/JBC 2012")
load(file.path(jbcdir,"jbcdat.rda"))
```
Load data in: `r round(Sys.time()- st,3)` secs.

Now reduce the data to samples with treatment level "siNS". I will write a function to subset the columns of our expression matrix (E) and subset the rows of the targets matrix (targets).

```{r subset-data}
geoid <- rownames(jbcdat$targets)[jbcdat$targets$treatment == "siNS"]
# write a function to subset the list objects using the column and row names
subEList <- function(ELst,geonames){
   sELst <-NULL
     sELst$targets <- ELst$targets[geonames,]
     sELst$E       <- ELst$E[,geonames]
     sELst$genes   <- ELst$genes
     sELst
}

siNSdat <- subEList(jbcdat,geoid)

# check the annotation and expression are both subset identically
identical(rownames(siNSdat$targets),colnames(siNSdat$E))
```

## MA plot

The MA plot is a plot of the difference in average log2 expression  in group 1 vs average log2 expression in group 2 (a.k.a Log2 Fold Change) vs the overall average log2 expression.

```{r MAplot}
Index1 <- which(siNSdat$target$hour=="0hr")
Index2 <- which(siNSdat$target$hour=="16hr")

d <- rowMeans(siNSdat$E[,Index2])-rowMeans(siNSdat$E[,Index1])
a <- rowMeans(siNSdat$E)

par(mfrow=c(1,2))
plot(a,d,xlab="Average (log2) intensity",ylab="Log2 Fold Change",main="MA plot",pch=".")

smoothScatter(a,d,nrpoints=500,
              xlab="Average (log2) intensity",
              ylab="Log2 Fold Change",
              main="MA plot")
abline(-1,0,col=7,lwd=3)
abline(1,0,col=7,lwd=3)
abline(0,0,col=2,lwd=3)
```

The figure on the right is faster to print, and will be a smaller size file to save than the figure on the left.

## 2s t-test

Here we do a single 2-sample (2s) t-test for each feature in our data set.

```{r ttests}
time2 <- ifelse(siNSdat$targets$hour=="16hr",1,2)
tt <- genefilter::rowttests(siNSdat$E,factor(time2))
head(tt,n=3)
```

Find the top 10 features ordered by statistical significance (10 smallest p-values).
```{r}
tt <- tt[order(tt$p.value),]
top10 <- head(tt,n=10)
top10
siNSdat$genes[rownames(top10),]
```

A volcano plot will allow us to visualize the results for all hypothesis tests in one figure.

## Volcano plot

The volcano plot is a scatterdiagram of -log10(P-value) vs log2 fold change.

```{r volcano-plot}
tt   <- genefilter::rowttests(siNSdat$E,factor(time2))
d    <- tt$dm
lodt <- (-log10(tt$p.value))

plot(d,lodt,main="Volcano plot for t-test",xlab="Log2 Fold Change",
	ylab="-log10 (P-value)",pch=".")
# make larger data points when -log10 pvalue > 5 
#  pch = 20 gives solid dots, col=4 is blue
points(d[lodt>5],lodt[lodt>5],pch=20,cex=0.5,col=4)
# If you want to write the gene symbol for the 10 most statistically.  significant features
rankp <- rank(tt$p.value)
text(d[rankp<=10],lodt[rankp<=10],
     siNSdat$genes$Symbol[rankp<=10],col="blue",cex=.7)
```




## 2s moderated t 

Now let's see how the results change if we run a moderated t-test.
```{r modT}
design <- model.matrix(~factor(siNSdat$targets$hour))

fit  <- limma::lmFit(siNSdat$E,design)
efit <- limma::eBayes(fit)
```

The limma package has a function for creating volcano plots.

```{r volcanoplot}
limma::volcanoplot(efit, coef = 2, style = "p-value", highlight = 10, names = siNSdat$genes$Symbol, hl.col="blue",
            xlab = "Log2 Fold Change", ylab = NULL, pch=16, cex=0.35)
```

The command topTable will summarize the regression results, ordered by p-value.

```{r TopT}
topT <- limma::topTable(efit,coef=2,n=10)
topT
```

Here is the annotation for these features:

```{r genenames}
siNSdat$genes[rownames(topT),]
```

## t-test vs mod t

Let's compare the 2 volcano plots:

```{r modTvolcanoplot, echo=FALSE}
par(mfrow=c(1,2))
lodmt <- -log10(efit$p.value[,2])
plot(d,lodt,main="2-sample t-test",xlab="Log2 Fold Change",
	ylab="-log10 (P-value)",pch=".", ylim=c(0,10.4))
rankp <- rank(tt$p.value)
text(d[rankp<=10],lodt[rankp<=10],
     siNSdat$genes$Symbol[rankp<=10],col="blue",cex=.7)


plot(d,lodmt,main="moderated t-test",xlab="Log2 Fold Change",
	ylab="-log10 (P-value)",pch=".", ylim=c(0,10.4))
rankp <- rank(efit$p.value[,2])
text(d[rankp<=10],lodmt[rankp<=10],
     siNSdat$genes$Symbol[rankp<=10],col="blue",cex=.7)

```

Name 2 differences you see comparing these 2 figures.

If we compare the IDs of the top 10 features identified from each method, only
`r length(intersect(rownames(top10),rownames(topT)))` appear in both lists. Why is this concordance so low? Let's compare the p-values from student's t-test and the moderated t-test.
```{r ttvmodt}
par(mar=c(5,5,3,2))
plot(lodt,lodmt,pch=".",cex.axis=1.2,cex.lab=1.2,
	xlab="-log10(p), 2-sample t",
	ylab="-log10(p), moderated t")
abline(0,1,col=2,lwd=3)
```

That's a pretty noisy association. What drives this scatter?

1. Was there a change in the difference in group means (Log2 Fold change)?

2. What about the standard deviation?
```{r sdplot}
plot(efit$sigma,sqrt(efit$s2.post),pch=".",
     xlab="Pooled sd",ylab="Moderated pooled sd")
abline(0,1)
segments(sqrt(efit$s2.prior),0,sqrt(efit$s2.prior),1,col=2)
text(0.2,0.8,"sd Prior",col=2,adj=0,lwd=3)
```

This shows how the moderated (pooled) standard deviation is "shrunk" closer to the prior, $s_0$. So, small standard deviations become a little bigger, making the moderated t-test smaller and less statistically significant. Large standard deviations are also shrunk towards the prior. This makes large standard deviations smaller, which makes the moderated t-test larger and more statistically significant.

Let's look at the expression of a gene that was highly significant with the t-test and is no longer so when using the moderated t-test.

```{r selectgene}
thisone <- which(lodt > 4 & lodmt < 1.05)
index <- order(siNSdat$targets$hour)
data <- cbind.data.frame(Index=1:8,
                         log2E = siNSdat$E[thisone,index],
                         time = siNSdat$targets$hour[index])
ggplot(data,  aes(x=Index, y=log2E, color = time)) + geom_point(size=2.5) +
  labs(color="Time") + ylab("Log2 Expression")
```

Although the expression level does separate the samples by time, this is a very lowly expressed gene, and the difference in group means is very small.  It could be that this is a chance occurrence due to the small sample size.

Now let's look at the expression signal coming from a feature that was highly significant by both the t-test and moderated t-test.

```{r selectgene2}
thisone <- which(lodt > 7 & lodmt > 10)
index <- order(siNSdat$targets$hour)
data <- cbind.data.frame(Index=1:8,
                         log2E = siNSdat$E[thisone,index],
                         time = siNSdat$targets$hour[index])
ggplot(data,  aes(x=Index, y=log2E, color = time)) + geom_point(size=2.5) +
  labs(color="Time") + ylab("Log2 Expression")
```

Now that's a highly expressed gene, with a large difference in mean expression between the two groups.

*Recommendation:* In small samples (n<10 per group), the moderated t-test is preferred because it selects fewer genes with small effect sizes. 

## SessionInfo

Total runtime: `r round(Sys.time()-st,3)` secs.

```{r sessionInfo}
sessionInfo()
```